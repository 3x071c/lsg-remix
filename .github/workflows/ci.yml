# This workflow runs "integration tests", to make sure everything's working fine before accidentally introducing bad code or a bug into the production website
name: ğŸ§ª Continuous Integration

on: push

# Cancel previous instances of this workflow
concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
    cancel-in-progress: true

jobs:
    lint:
        name: â˜‘ï¸ ESLint # ESLint "lints" our TypeScript/JavaScript code, making sure it's correct, conforms to our style and isn't poorly written
        runs-on: ubuntu-latest # This used to be a matrix test on different platforms
        timeout-minutes: 15
        steps:
            - name: ğŸ§³ Checkout
              uses: actions/checkout@v3.0.0
            - name: â” Setup
              uses: actions/setup-node@v3.0.0
              with:
                  node-version: 16 # Use the latest LTS release
                  cache: npm
            - name: ğŸ“¥ Install
              uses: nick-fields/retry@v2.6.0 # Retry npm installation when an http download fails (often due to rate limiting)
              with:
                  timeout_minutes: 5
                  max_attempts: 3
                  command: npm ci # Installs dependencies without modifying lockfile (for production installs)
                  retry_wait_seconds: 60
            - name: ğŸ§¬ Generate Types
              run: npm run generate
              env:
                  ci: true
                  NODE_ENV: production
            - name: ğŸ”¬ Lint
              run: npm run lint
              env:
                  ci: true
                  NODE_ENV: production
    typecheck:
        name: Ê¦ TypeScript # TypeScript checks the static typings in our code
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: ğŸ§³ Checkout
              uses: actions/checkout@v3.0.0
            - name: â” Setup
              uses: actions/setup-node@v3.0.0
              with:
                  node-version: 16 # Use the latest LTS release
                  cache: npm
            - name: ğŸ“¥ Install
              uses: nick-fields/retry@v2.6.0 # Retry npm installation when an http download fails (often due to rate limiting)
              with:
                  timeout_minutes: 5
                  max_attempts: 3
                  command: npm ci # Installs dependencies without modifying lockfile (for production installs)
                  retry_wait_seconds: 60
            - name: ğŸ§¬ Generate Types
              run: npm run generate
              env:
                  ci: true
                  NODE_ENV: production
            - name: Run Tests
              run: npm run check
              env:
                  ci: true
                  NODE_ENV: production
